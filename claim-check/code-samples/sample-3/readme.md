# Sample 3: Automatic claim check token generation with Event Grid, Service Bus as messaging system

## Technologies used: Azure Blob Storage, Azure Event Grid, Azure Service Bus, Azure Functions, .NET 8.0

Like in samples 1 and 2, a reference message is automatically generated by [Event Grid](https://azure.microsoft.com/services/event-grid/) when the payload is uploaded to Azure Blob Storage. In this sample, [Service Bus](https://learn.microsoft.com/azure/service-bus) is used as the messaging system.

Forwarding Event Grid events to Service Bus simplifies integration with existing Service Bus solutions. Your solution can also take advantage of its unique capabilities, like its enterprise messaging capabilities and transactional message processing.

> This example uses [`DefaultAzureCredential`](https://learn.microsoft.com/dotnet/azure/sdk/authentication/#defaultazurecredential) for authentication while accessing Azure resources. the user principal must be provided as a parameter to the included Bicep script. The Bicep script is responsible for assigning the necessary RBAC (Role-Based Access Control) permissions for accessing the various Azure resources. While the principal can be the account associated with the interactive user, there are alternative [configurations](https://learn.microsoft.com/dotnet/azure/sdk/authentication/?tabs=command-line#exploring-the-sequence-of-defaultazurecredential-authentication-methods) available.

![A diagram showing Event Grid connected to Azure Blob Storage. As blobs are created, Event Grid forwards a message, containing the reference to the blob, to Service Bus queue. A consumer Function receives the message from the queue, extracts the reference, and dowloads the blob from the storage account.](images/sample-3-diagram.png)

1. The payload uploaded to Azure Blob Storage.
1. A Blob Created event is generated by Event Grid.
1. Event Grid forwards the event, containing a reference to the payload blob, to an Azure Service Bus queue.
1. An Azure Function connects to the queue and reads messages as they arrive.
1. The Function extracts the reference to the payload blob from the message and downloads the blob directly from storage.

## :rocket: Deployment guide

Install the prerequisites and follow the steps to deploy and run the examples.

### Prerequisites

- Permission to create a new resource group and resources in an [Azure subscription](https://azure.com/free)
- Unix-like shell. Also available in:
  - [Azure Cloud Shell](https://shell.azure.com/)
  - [Windows Subsystem for Linux (WSL)](https://learn.microsoft.com/windows/wsl/install)
- [Git](https://git-scm.com/downloads)
- [.NET 8 SDK](https://dotnet.microsoft.com/download/dotnet/8.0)
- [Azure Functions Core Tools](https://learn.microsoft.com/azure/azure-functions/functions-run-local#install-the-azure-functions-core-tools)
- [Azurite](/azure/storage/common/storage-use-azurite)
- [Azure CLI](https://learn.microsoft.com/cli/azure/install-azure-cli)
- Optionally, an IDE, like  [Visual Studio](https://visualstudio.microsoft.com/downloads/) or [Visual Studio Code](https://code.visualstudio.com/).

### Steps

1. Clone this repository to your workstation and navigate to the working directory.

   ```shell
   git clone https://github.com/mspnp/cloud-design-patterns
   cd cloud-design-patterns/claim-check/code-samples/sample-3
   ```

1. Log into Azure and create an empty resource group.

   ```azurecli
   az login
   az account set -s <Name or ID of subscription>

   NAME_PREFIX=<unique value between three to five characters>
   az group create -n "rg-${NAME_PREFIX}" -l eastus2
   ```

1. Deploy the supporting Azure resources.

   ```azurecli
   CURRENT_USER_OBJECT_ID=$(az ad signed-in-user show -o tsv --query id)

   # This could take a few minutes
   az deployment group create -n deploy-claim-check -f bicep/main.bicep -g "rg-${NAME_PREFIX}" -p namePrefix=$NAME_PREFIX principalId=$CURRENT_USER_OBJECT_ID
   ```

1. Configure the samples to use the created Azure resources.

   ```shell
   sed "s/{SERVICE_BUS_NAMESPACE}/evhns-${NAME_PREFIX}/g" FunctionConsumer3/local.settings.json.template > FunctionConsumer3/local.settings.json
   ```

1. [Run Azurite](https://learn.microsoft.com/azure/storage/common/storage-use-azurite#run-azurite) blob storage emulation service.

   > The local storage emulator is required as an Azure Storage account is a required "backing resource" for Azure Functions.

1. Launch the consumer sample application to receive and process claim check messages from Service Bus.

   The message consumer sample application for this scenario is implemented as an Azure Function, showcasing the serveless approach. Run the sample application to connect to the the Service Bus queue and process messages as they arrive.

   Two applications are provided as sample that illustrate consuming the claim check message sent via Azure Event Hubs: one implemented as a Command Line Interface (CLI) application, and the other one implemented as an Azure Function, showcasing the serveless approach.

   ```bash
   cd sample-3\FunctionConsumer3
   func start
   ```

  > Please note: For demo purposes, the sample application will write the payload content to the the screen. Keep that in mind before you try sending really large payloads.

### :checkered_flag: Try it out

To generate a claim check message you just have to drop a file in the created Azure Storage account. You can use Azure **Storage browser** to do that. [Refer this to know how to upload blobs to a container using Storage Explorer](https://learn.microsoft.com/azure/storage/blobs/quickstart-storage-explorer#upload-blobs-to-the-container).

### :broom: Clean up

Remove the resource group that you created when you are done with this sample.

```azurecli
az group delete -n "rg-${NAME_PREFIX}"
```
