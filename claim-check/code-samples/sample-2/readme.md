# Sample 2: Automatic claim check token generation with Event Grid, Event Hubs as messaging system

## Technologies used: Azure Blob Storage, Azure Event Grid, Azure Event Hub, .NET 9.0

Like in Sample 1, a reference message is automatically generated by [Event Grid](https://azure.microsoft.com/services/event-grid/) when the payload is uploaded to Azure Blob Storage. In this sample, [Event Hubs](https://learn.microsoft.com/azure/event-hubs) is used as the messaging system.

Using Event Hubs enable integration with a existing Event Hub-based solutions and to take advantage of its unique capabilities, like schema registry support and Apache Kafka compatibility. And Event Hub can be configured to [automatically archive](https://learn.microsoft.com/azure/event-hubs/event-hubs-capture-overview) received messages to make then available as an Avro files for integration with tools like Apache Spark, Stream Analytics, and Azure Data Factory.

> This example uses [`DefaultAzureCredential`](https://learn.microsoft.com/dotnet/azure/sdk/authentication/#defaultazurecredential) for authentication while accessing Azure resources. the user principal must be provided as a parameter to the included Bicep script. The Bicep script is responsible for assigning the necessary RBAC (Role-Based Access Control) permissions for accessing the various Azure resources. While the principal can be the account associated with the interactive user, there are alternative [configurations](https://learn.microsoft.com/dotnet/azure/sdk/authentication/?tabs=command-line#exploring-the-sequence-of-defaultazurecredential-authentication-methods) available.

![A diagram showing Event Grid connected to Azure Blob Storage. As blobs are created, Event Grid forwards a message, containing the reference to the blob, to an Event Hub. A consumer CLI application receives the message from the queue, extracts the reference, and dowloads the blob from the storage account.](images/sample-2-diagram.png)

1. The payload uploaded to Azure Blob Storage.
1. A Blob Created event is generated by Event Grid.
1. Event Grid forwards the event, containing a reference to the payload blob, to an Azure Event Hub.
1. An net console program connects to the Event Hub and reads messages as they arrive.
1. The net console program extracts the reference to the payload blob from the message and downloads the blob directly from storage.

## :rocket: Deployment guide

Install the prerequisites and follow the steps to deploy and run the examples.

### Prerequisites

- Permission to create a new resource group and resources in an [Azure subscription](https://azure.com/free)
- Unix-like shell. Also available in:
  - [Azure Cloud Shell](https://shell.azure.com/)
  - [Windows Subsystem for Linux (WSL)](https://learn.microsoft.com/windows/wsl/install)
- [Git](https://git-scm.com/downloads)
- [.NET 9 SDK](https://dotnet.microsoft.com/download/dotnet/9.0)
- [Azure CLI](https://learn.microsoft.com/cli/azure/install-azure-cli)
- Optionally, an IDE, like [Visual Studio](https://visualstudio.microsoft.com/downloads/) or [Visual Studio Code](https://code.visualstudio.com/).

### Steps

1. Clone this repository to your workstation and navigate to the working directory.

  ```bash
  git clone https://github.com/mspnp/cloud-design-patterns
  cd cloud-design-patterns/claim-check/code-samples/sample-2
  ```  

2. Log into Azure and create an empty resource group.

  ```bash
  az login
  az account set -s <Name or ID of subscription>

  NAME_PREFIX="<unique value between three to five characters>"
  LOCATION=eastus2
  RESOURCE_GROUP_NAME="rg-${NAME_PREFIX}-${LOCATION}"

  az group create -n "${RESOURCE_GROUP_NAME}" -l ${LOCATION}
  ```  

3. Deploy the supporting Azure resources.

  ```bash
  CURRENT_USER_OBJECT_ID=$(az ad signed-in-user show -o tsv --query id)

  # This could take a few minutes
  az deployment group create -n deploy-claim-check -f bicep/main.bicep -g "${RESOURCE_GROUP_NAME}" -p namePrefix=$NAME_PREFIX principalId=$CURRENT_USER_OBJECT_ID
  ```  

4. Configure the sample consumer to use the created Azure resources.

  ```bash
  sed "s/{EVENT_HUBS_NAMESPACE}/evhns-${NAME_PREFIX}/g" ClientConsumer2/appsettings.json.template >ClientConsumer2/appsettings.json
  sed -i "s/{EVENT_PROCESSOR_STORAGE_ACCOUNT_NAME}/st${NAME_PREFIX}ehub/g" ClientConsumer2/appsettings.json
  ```  

5. Launch the consumer sample application to receive and process claim check messages from Event Hubs.

   The message consumer sample application for this scenario is implemented as a Command Line Interface (CLI) application. Run the sample application to connect to Event Hubs and process messages as they arrive.

  ```bash
  dotnet run --project ClientConsumer2
  ```  

> Please note: For demo purposes, the sample application will write the payload content to the the screen. Keep that in mind before you try sending really large payloads.

### :checkered_flag: Try it out

To generate a claim check message you just have to drop a file in the created Azure Storage account. You can use Azure **Storage browser** to do that. [Refer this to know how to upload blobs to a container using Storage Explorer](https://learn.microsoft.com/azure/storage/blobs/quickstart-storage-explorer#upload-blobs-to-the-container).

### :broom: Clean up

Remove the resource group that you created when you are done with this sample.

  ```bash
  az group delete -n "${RESOURCE_GROUP_NAME}" -y
  ```  
