# Priority Queue Pattern

This document describes the Priority Queue Pattern example from the guide [Cloud Design Patterns](http://aka.ms/Cloud-Design-Patterns).

## System Requirements

* Microsoft .NET Core 3.1
* Microsoft Visual Studio 2019
* Windows Azure SDK for .NET version 3.1

## Before you start

Ensure that you have installed all of the software prerequisites.

The example demonstrates operational aspects of applications running in Windows Azure. Therefore, you will need to use the diagnostics tools in order to understand how the code sample works. You **must** ensure that the Azure Functions in the solution are configured to use the diagnostics mechanism. If not, you will not see the trace information generated by the example.

## About the Example

This example shows how you can implement priority queues by using Service Bus Topics and Subscriptions. A timer triggered Azure Function is responsible for sending messages to a topic. It assigns a priority to each message. The receiving Azure Functions read messages from subscriptions that have the corresponding priority. In the example, The PriorityQueueConsumerHigh Azure function runs with two instances, whereas the PriorityQueueConsumerLow worker runs only with one. This ensures that high priority messages are read from the queue more quickly than low priority messages.


## Running the Example

You can run this example locally in the Visual Studio Windows Azure emulator. You can also run this example by deploying it to a Function App Service.

* Start Visual Studio using an account that has Administrator privileges ("Run as Administrator").
* Open the solution you want to explore from the subfolders where you downloaded the examples.
* Right-click on each role in Solution Explorer, select Properties, and ensure that the role is configured to generate diagnostic information.
* Provision a Windows Azure Service Bus Namespace
* Edit the local.settings.json file in all the projects and change the ServiceBusConnectionString setting by changing the placeholders "[your namespace]" and "[your secret]" to your own values:
* If you want to run the example in the local Windows Azure emulator:
	* Set the PriorityQueueSender project as startup.
	* Press F5 in Visual Studio to start the example running. The function will start sending messages to the topic, every 30 seconds.
	* Stop the execution, change the startup project to either the PriorityQueueConsumerHigh or PriorityQueueConsumerLow
	* Press F5 in Visual Studio to start the execution of the consumer function
	* In the Azure Functions Core Tools Console, you can view the diagnostic information generated by Trace statements in the code.

* If you want to run the example on Windows Azure:
	* Provision a Windows Azure Cloud Service and deploy the application to it from Visual Studio.
	* Open the Server Explorer Window in Visual Studio and expand the Windows Azure entry.
	* Expand Cloud Services and then expand the entry for the solution you deployed.
	* Right-click each role instance and select View Diagnostics Data to see the diagnostic information generated by Trace statements in the code. This is written to the WADLogsTable in the Storage/Development/Tables section.






